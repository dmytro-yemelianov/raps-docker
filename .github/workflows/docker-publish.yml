name: Build and Push to DockerHub & GHCR

on:
  # Check for new RAPS releases daily
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily
  
  # Trigger from main RAPS repo via repository_dispatch
  repository_dispatch:
    types: [raps-release]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'RAPS version (leave empty for latest)'
        required: false
        default: ''

env:
  DOCKERHUB_REPO: dmytroyemelianov/raps
  GHCR_REPO: ghcr.io/dmytro-yemelianov/raps
  RAPS_REPO: dmytro-yemelianov/raps

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest RAPS version
        id: latest
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # Manual input provided
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Triggered from RAPS repo
            VERSION="${{ github.event.client_payload.version }}"
          else
            # Fetch latest from GitHub API
            VERSION=$(curl -s "https://api.github.com/repos/${{ env.RAPS_REPO }}/releases/latest" | jq -r '.tag_name')
          fi
          # Always strip 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸŒ¼ Building RAPS version: $VERSION"

      - name: Check if Docker image exists
        id: check
        run: |
          VERSION="${{ steps.latest.outputs.version }}"
          # Check if this version already exists on DockerHub
          if curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKERHUB_REPO }}/tags/${VERSION}" | jq -e '.name' > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ Version $VERSION already exists on DockerHub, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Version $VERSION not found, will build"
          fi

      - name: Set up QEMU
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_REPO }}
            ${{ env.GHCR_REPO }}
          tags: |
            type=raw,value=${{ steps.latest.outputs.version }}
            type=raw,value=latest

      - name: Build and push
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.latest.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update DockerHub description
        if: steps.check.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_REPO }}
          readme-filepath: ./README.md

      - name: Summary
        run: |
          echo "## ðŸŒ¼ RAPS Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.latest.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DockerHub:** \`${{ env.DOCKERHUB_REPO }}:${{ steps.latest.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR:** \`${{ env.GHCR_REPO }}:${{ steps.latest.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.exists }}" = "true" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "- **Status:** â­ï¸ Skipped (already exists)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âœ… Built and pushed" >> $GITHUB_STEP_SUMMARY
          fi
